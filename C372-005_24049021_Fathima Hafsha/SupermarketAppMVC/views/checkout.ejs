<%- include("partials/header"); %>

    <div class="container mt-4 mb-5" style="max-width: 700px;">

        <h2 class="fw-bold mb-4 text-center">Checkout</h2>

        <div class="card p-4 shadow-sm">

            <h4 class="mb-3 fw-bold">Order Summary</h4>

            <% cart.forEach(item=> { %>
                <div class="d-flex justify-content-between border-bottom py-2">
                    <div>
                        <strong>
                            <%= item.productName %>
                        </strong><br>
                        Quantity: <%= item.quantity %>
                    </div>
                    <div>
                        $<%= (item.price * item.quantity).toFixed(2) %>
                    </div>
                </div>
                <% }); %>

                    <div class="d-flex justify-content-between mt-3">
                        <h4>Total:</h4>
                        <h4 class="fw-bold">$<%= total.toFixed(2) %>
                        </h4>
                    </div>

                    <hr class="my-4">

                    <!-- PAYPAL PAYMENT -->
                    <h5 class="fw-bold mb-3">Pay with PayPal</h5>

                    <div id="paypal-button-container"></div>

                    <!-- PayPal SDK (Class style: uses env) -->
                    <script
                        src="https://www.paypal.com/sdk/js?client-id=AdfQO3UbfWTbVRPz8vlfrFo5tLrD0sYxyb2F4dk_G1ShnvyBenNoouJWmUBdkniuXhPHpkzjvg7eywnf&currency=SGD"></script>

                    <script>
                        paypal.Buttons({

                            // call backend create-order with amount
                            createOrder: function () {
                                return fetch('/api/paypal/create-order', {
                                    method: 'post',
                                    headers: { 'content-type': 'application/json' },
                                    body: JSON.stringify({ amount: "<%= total.toFixed(2) %>" })
                                })
                                    .then(res => res.json())
                                    .then(data => data.id);
                            },

                            // call backend capture-order with PayPal orderID
                            onApprove: function (data) {
                                return fetch('/api/paypal/capture-order', {
                                    method: 'post',
                                    headers: { 'content-type': 'application/json' },
                                    body: JSON.stringify({ orderID: data.orderID })
                                })
                                    .then(res => res.json())
                                    .then(result => {
                                        if (result.success) {
                                            window.location.href = "/checkout/success?orderId=" + result.orderId;
                                        } else {
                                            alert(result.error || "Payment not completed.");
                                        }
                                    });
                            },

                            onCancel: function () {
                                alert("Payment cancelled.");
                            },

                            onError: function (err) {
                                console.error(err);
                                alert("PayPal error: " + err.message);
                            }

                        }).render('#paypal-button-container');
                    </script>

        </div>
    </div>

    <%- include("partials/footer"); %>