<%- include("partials/header"); %>

<div class="container py-4" style="max-width: 1200px;">
  <% if (!cart || cart.length === 0) { %>
    <div class="alert alert-info">
      <i class="bi bi-info-circle me-2"></i> Your cart is empty.
      <a href="/shopping" class="alert-link">Continue shopping</a>
    </div>
  <% } else { %>
  <div class="row g-4">
    <!-- Cart Items (Left) -->
    <div class="col-lg-7">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
              <h4 class="fw-bold mb-0">Your cart</h4>
              <small class="text-muted">Select items to proceed</small>
            </div>
            <button class="btn btn-sm btn-outline-secondary" id="selectAllBtn">
              <i class="bi bi-check2-square me-1"></i> Select All
            </button>
          </div>

          <div id="cartItems">
            <% cart.forEach((item, idx)=> { %>
              <% const slug = (item.productName || '').toLowerCase().replace(/[^a-z0-9]+/g, '-'); %>
              <% const slugTight = (item.productName || '').toLowerCase().replace(/[^a-z0-9]+/g, ''); %>
              <div class="d-flex align-items-center gap-3 p-3 border-bottom cart-item" data-idx="<%= idx %>" data-price="<%= item.price %>" data-qty="<%= item.quantity %>">
                <input type="checkbox" class="form-check-input item-check flex-shrink-0" style="width:20px;height:20px;" checked>
                <div class="ratio ratio-1x1 flex-shrink-0" style="width:80px;">
                  <img class="img-fluid rounded"
                       src="<%= item.image || ('/images/' + slug.replace(/-+$/,'') + '.png') %>"
                       alt="<%= item.productName %>"
                       data-fidx="0"
                       onerror="
                         const alts = [
                           '<%= item.image || '' %>',
                           '/images/<%= slug.replace(/-+$/,'') %>.png',
                           '/images/<%= slug.replace(/-+$/,'') %>.jpg',
                           '/images/<%= slugTight %>.png',
                           '/images/<%= slugTight %>.jpg',
                           '/images/<%= slug %>.png',
                           '/images/<%= slug %>.jpg',
                           '/images/<%= slug %>.webp',
                           '/images/placeholder.png'
                         ].filter(Boolean);
                         let i = parseInt(this.dataset.fidx || '0', 10);
                         if (i < alts.length) { this.dataset.fidx = i + 1; this.src = alts[i]; }
                       ">
                </div>
                <div class="flex-grow-1 min-width-0">
                  <div class="fw-semibold text-truncate"><%= item.productName %></div>
                  <div class="small text-muted">$<%= Number(item.price).toFixed(2) %> each</div>
                </div>
                <div class="flex-shrink-0 text-end">
                  <div class="badge bg-secondary fs-6">×<%= item.quantity %></div>
                  <div class="small fw-bold mt-1">$<%= (Number(item.price) * item.quantity).toFixed(2) %></div>
                </div>
              </div>
            <% }); %>
          </div>
        </div>
      </div>
    </div>

    <!-- Order Summary (Right) -->
    <div class="col-lg-5">
      <div class="card shadow-sm border-0 position-sticky" style="top: 90px;">
        <div class="card-body">
          <!-- Header -->
          <h5 class="fw-bold mb-1">Order Summary</h5>
          <small class="text-muted d-block mb-3">All prices include tax</small>

          <!-- Subtotal -->
          <div class="border-top border-bottom py-3 mb-3">
            <div class="d-flex justify-content-between small mb-2">
              <span>Subtotal</span>
              <span id="subtotalDisplay">$<%= (benefits?.base || total).toFixed(2) %></span>
            </div>
            <div class="d-flex justify-content-between small mb-2">
              <span>Delivery fee</span>
              <span id="deliveryFeeDisplay"><%= (benefits?.deliveryFee || 2.0) > 0 ? '$' + (benefits.deliveryFee || 2.0).toFixed(2) : 'FREE' %></span>
            </div>
            <div class="d-flex justify-content-between small">
              <span>Benefits discount</span>
              <span id="benefitDiscountDisplay" class="text-success">- $<%= (benefits?.discount || 0).toFixed(2) %></span>
            </div>
            <div class="d-flex justify-content-between small">
              <span>Promo discount</span>
              <span id="promoDiscountDisplay" class="text-success">-$0.00</span>
            </div>
          </div>

          <!-- Total -->
          <div class="d-flex justify-content-between mb-3">
            <span class="fw-bold">Total</span>
            <h4 class="fw-bold text-success mb-0" id="totalDisplay">$<%= (benefits?.total || total).toFixed(2) %></h4>
          </div>

          <!-- Promo Code -->
          <div class="mb-3">
            <label class="form-label small fw-bold">Promo Code</label>
            <div class="input-group input-group-sm">
              <input type="text" class="form-control" id="promoCode" placeholder="e.g. SAVE10" maxlength="50">
              <button class="btn btn-outline-primary" id="applyPromo" type="button">Apply</button>
            </div>
            <div id="promoMsg" class="small mt-2" style="min-height:20px;"></div>
          </div>

          <!-- Delivery Timing -->
          <div class="mb-3">
            <label class="form-label small fw-bold">Delivery Timing</label>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="deliveryType" value="NOW" id="deliverNow" checked>
              <label class="form-check-label" for="deliverNow">
                Deliver now <small class="text-muted">(45 mins)</small>
              </label>
            </div>
            <div class="form-check">
              <input class="form-check-input" type="radio" name="deliveryType" value="SCHEDULED" id="deliverLater">
              <label class="form-check-label" for="deliverLater">Schedule for later</label>
            </div>
            <div id="scheduleFields" class="row g-2 mt-2 d-none">
              <div class="col-md-6">
                <input type="date" id="scheduleDate" class="form-control form-control-sm" min="<%= new Date().toISOString().split('T')[0] %>">
              </div>
              <div class="col-md-6">
                <select id="scheduleTime" class="form-select form-select-sm">
                  <% for (let h=9; h<=21; h++) { for (let m of [0,15,30,45]) { const hh = h.toString().padStart(2,'0'); const mm = m.toString().padStart(2,'0'); %>
                    <option value="<%= hh %>:<%= mm %>"><%= hh %>:<%= mm %></option>
                  <% }} %>
                </select>
              </div>
              <div class="col-12">
                <div id="scheduleAlert" class="alert alert-danger py-2 px-3 d-none small mb-0"></div>
              </div>
            </div>
          </div>

          <!-- Payment Methods -->
          <div>
            <h6 class="fw-bold mb-2">Payment Method</h6>
            <div class="list-group list-group-sm mb-3" id="method-list">
              <label class="list-group-item d-flex align-items-center gap-2">
                <input class="form-check-input flex-shrink-0" type="radio" name="payMethod" value="stripe" checked>
                <div class="flex-grow-1 min-width-0">
                  <div class="fw-bold small">Card / Stripe</div>
                  <small class="text-muted">Secure payment</small>
                </div>
              </label>
              <label class="list-group-item d-flex align-items-center gap-2">
                <input class="form-check-input flex-shrink-0" type="radio" name="payMethod" value="paypal">
                <div class="flex-grow-1 min-width-0">
                  <div class="fw-bold small">PayPal</div>
                  <small class="text-muted">PayPal account</small>
                </div>
              </label>
              <label class="list-group-item d-flex align-items-center gap-2">
                <input class="form-check-input flex-shrink-0" type="radio" name="payMethod" value="nets">
                <div class="flex-grow-1 min-width-0">
                  <div class="fw-bold small">NETS QR</div>
                  <small class="text-muted">Not refundable</small>
                </div>
              </label>
            </div>
          </div>

          <!-- Payment Panes -->
          <div id="paymentContainer">
            <div class="pay-pane" data-method="stripe">
              <button id="stripe-pay" class="btn btn-primary w-100" disabled>
                <span class="spinner-border spinner-border-sm d-none me-2"></span>
                <i class="bi bi-lock-fill me-1"></i> Pay with Stripe
              </button>
              <div id="stripe-status" class="text-danger small mt-2 d-none"></div>
            </div>
            <div class="pay-pane d-none" data-method="paypal">
              <div id="paypal-button-container"></div>
            </div>
            <div class="pay-pane d-none" data-method="nets">
              <div class="alert alert-warning py-2 small mb-2">
                <i class="bi bi-exclamation-triangle-fill me-2"></i>
                Not refundable via app
              </div>
              <button id="nets-generate" class="btn btn-outline-danger w-100" disabled>
                <span class="spinner-border spinner-border-sm d-none me-2"></span>
                <i class="bi bi-qr-code me-1"></i> Generate NETS QR
              </button>
              <div id="nets-status" class="text-danger small mt-2 d-none"></div>
              <div id="nets-qr-container" class="d-flex justify-content-center mt-2"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <% } %>
</div>

<!-- SDKs -->
<script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= currency %>&disable-funding=card"></script>
<script src="https://js.stripe.com/v3"></script>

<script>
(function () {
  // Elements
  const selectAllBtn = document.getElementById("selectAllBtn");
  const itemChecks = document.querySelectorAll(".item-check");
  const cartItems = document.querySelectorAll(".cart-item");
  const methodRadios = document.querySelectorAll('input[name="payMethod"]');
  const deliveryRadios = document.querySelectorAll('input[name="deliveryType"]');
  const scheduleFields = document.getElementById("scheduleFields");
  const scheduleDate = document.getElementById("scheduleDate");
  const scheduleTime = document.getElementById("scheduleTime");
  const scheduleAlert = document.getElementById("scheduleAlert");
  const promoInput = document.getElementById("promoCode");
  const promoMsg = document.getElementById("promoMsg");
  const applyPromoBtn = document.getElementById("applyPromo");
  const stripeBtn = document.getElementById("stripe-pay");
  const netsBtn = document.getElementById("nets-generate");
  const subtotalDisplay = document.getElementById("subtotalDisplay");
  const deliveryFeeDisplay = document.getElementById("deliveryFeeDisplay");
  const benefitDiscountDisplay = document.getElementById("benefitDiscountDisplay");
  const promoDiscountDisplay = document.getElementById("promoDiscountDisplay");
  const totalDisplay = document.getElementById("totalDisplay");
  const plan = ("<%= benefits?.plan || 'NONE' %>").toUpperCase();
  let promoApplied = null;

  // Select all / deselect all
  selectAllBtn?.addEventListener("click", () => {
    const allChecked = Array.from(itemChecks).every(c => c.checked);
    itemChecks.forEach(c => c.checked = !allChecked);
    updateSummary();
  });

  itemChecks.forEach(c => c.addEventListener("change", updateSummary));

  function calcDeliveryAndBenefit(subtotal) {
    const defaultDelivery = 2.0;
    let deliveryFee = defaultDelivery;
    let benefitDiscount = 0;
    if (plan === 'PREMIUM') {
      deliveryFee = subtotal >= 5 ? 0 : defaultDelivery;
      benefitDiscount = 1.5;
    } else if (plan === 'BASIC') {
      deliveryFee = subtotal >= 10 ? 0 : defaultDelivery;
    } else {
      // no subscription: still waive delivery for larger baskets (>=10)
      deliveryFee = subtotal >= 10 ? 0 : defaultDelivery;
    }
    return { deliveryFee, benefitDiscount };
  }

  function updateSummary() {
    const selected = Array.from(itemChecks).filter(c => c.checked);
    const selectedSum = selected.reduce((sum, check) => {
      const item = check.closest(".cart-item");
      const price = parseFloat(item.dataset.price);
      const qty = parseInt(item.dataset.qty);
      return sum + (price * qty);
    }, 0);
    const { deliveryFee, benefitDiscount } = calcDeliveryAndBenefit(selectedSum);
    const promoDiscount = promoApplied ? promoApplied.discount : 0;
    const total = selectedSum + deliveryFee - benefitDiscount - promoDiscount;
    subtotalDisplay.textContent = "$" + selectedSum.toFixed(2);
    deliveryFeeDisplay.textContent = deliveryFee > 0 ? "$" + deliveryFee.toFixed(2) : "FREE";
    benefitDiscountDisplay.textContent = "- $" + benefitDiscount.toFixed(2);
    promoDiscountDisplay.textContent = promoDiscount > 0 ? "-$" + promoDiscount.toFixed(2) : "-$0.00";
    totalDisplay.textContent = "$" + total.toFixed(2);

    const hasSelection = selected.length > 0;
    stripeBtn.disabled = !hasSelection;
    netsBtn.disabled = !hasSelection;
  }

  // Delivery timing
  deliveryRadios.forEach(r => r.addEventListener("change", () => {
    const isScheduled = document.querySelector('input[name="deliveryType"]:checked')?.value === "SCHEDULED";
    scheduleFields.classList.toggle("d-none", !isScheduled);
  }));

  function getDeliverySelection() {
    const selected = document.querySelector('input[name="deliveryType"]:checked')?.value || "NOW";
    if (selected === "SCHEDULED") {
      const d = scheduleDate.value;
      const t = scheduleTime.value;
      return { deliveryType: "SCHEDULED", scheduledAt: d && t ? `${d}T${t}:00` : null };
    }
    return { deliveryType: "NOW", scheduledAt: null };
  }

  function validateSchedule() {
    const sel = getDeliverySelection();
    if (sel.deliveryType !== "SCHEDULED") return true;
    if (!sel.scheduledAt) {
      scheduleAlert.textContent = "Pick a date and time.";
      scheduleAlert.classList.remove("d-none");
      return false;
    }
    const sched = new Date(sel.scheduledAt);
    const min = new Date(Date.now() + 45 * 60000);
    if (sched < min) {
      scheduleAlert.textContent = "Scheduled time must be at least 45 minutes from now.";
      scheduleAlert.classList.remove("d-none");
      return false;
    }
    scheduleAlert.classList.add("d-none");
    return true;
  }

  // Promo code
  applyPromoBtn?.addEventListener("click", async (e) => {
    e.preventDefault();
    const code = promoInput.value.trim();
    if (!code) {
      promoMsg.textContent = "";
      promoApplied = null;
      updateSummary();
      return;
    }

    try {
      const res = await fetch("/api/promo/validate", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({ code, subtotal: parseFloat(subtotalDisplay.textContent.slice(1)) })
      });
      const data = await res.json();
      if (data.applied) {
        promoMsg.innerHTML = `<span class="text-success"><i class="bi bi-check-circle me-1"></i>${data.message}</span>`;
        promoApplied = data;
      } else {
        promoMsg.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle me-1"></i>${data.message}</span>`;
        promoApplied = null;
      }
      updateSummary();
    } catch (err) {
      promoMsg.innerHTML = `<span class="text-danger">Error applying promo</span>`;
      promoApplied = null;
    }
  });

  // Payment method switching
  methodRadios.forEach(r => r.addEventListener("change", () => {
    const method = r.value;
    document.querySelectorAll(".pay-pane").forEach(pane => {
      pane.classList.toggle("d-none", pane.dataset.method !== method);
    });
  }));

  function getSelectedItems() {
    const selected = [];
    itemChecks.forEach((check, idx) => {
      if (check.checked) {
        const item = cartItems[idx];
        selected.push({ idx, price: parseFloat(item.dataset.price), qty: parseInt(item.dataset.qty) });
      }
    });
    return selected;
  }

  function getCommonPayload() {
    return {
      promoCode: promoApplied?.code || "",
      selectedIndices: getSelectedItems().map(s => s.idx),
      ...getDeliverySelection()
    };
  }

  // Stripe handler
  stripeBtn?.addEventListener("click", async () => {
    if (!validateSchedule()) return;
    const selected = getSelectedItems();
    if (selected.length === 0) {
      alert("Please select at least one item.");
      return;
    }

    stripeBtn.disabled = true;
    stripeBtn.querySelector(".spinner-border")?.classList.remove("d-none");
    const statusEl = document.getElementById("stripe-status");
    statusEl.classList.add("d-none");

    try {
      const res = await fetch("/api/stripe/create-session", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(getCommonPayload())
      });
      const data = await res.json();
      if (!res.ok || !data.id) throw new Error(data.error || "Stripe error");

      const stripe = Stripe("<%= stripePublishableKey %>");
      const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
      if (error) throw error;
    } catch (err) {
      statusEl.textContent = err.message || "Unable to start payment.";
      statusEl.classList.remove("d-none");
      stripeBtn.disabled = false;
      stripeBtn.querySelector(".spinner-border")?.classList.add("d-none");
    }
  });

  // NETS handler
  netsBtn?.addEventListener("click", async () => {
    if (!validateSchedule()) return;
    const selected = getSelectedItems();
    if (selected.length === 0) {
      alert("Please select at least one item.");
      return;
    }

    netsBtn.disabled = true;
    netsBtn.querySelector(".spinner-border")?.classList.remove("d-none");
    const statusEl = document.getElementById("nets-status");
    statusEl.classList.add("d-none");
    document.getElementById("nets-qr-container").innerHTML = "";

    try {
      const res = await fetch("/api/nets/qr-request", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify(getCommonPayload())
      });
      const data = await res.json();
      if (!res.ok || !data.qrDataUrl) throw new Error(data.error || "Unable to create NETS QR.");

      const img = document.createElement("img");
      img.src = data.qrDataUrl;
      img.alt = "NETS QR Code";
      img.className = "img-fluid border p-2 bg-white";
      img.style.maxWidth = "360px";
      img.style.minWidth = "280px";
      document.getElementById("nets-qr-container").appendChild(img);
      startNetsPoll(data.txn_retrieval_ref);
    } catch (err) {
      statusEl.textContent = err.message;
      statusEl.classList.remove("d-none");
      netsBtn.disabled = false;
      netsBtn.querySelector(".spinner-border")?.classList.add("d-none");
    }
  });

  async function startNetsPoll(txnRef) {
    let attempts = 0;
    const pollHandle = setInterval(async () => {
      attempts++;
      try {
        const res = await fetch(`/api/nets/query?txn_retrieval_ref=${encodeURIComponent(txnRef)}`);
        const data = await res.json();

        if (data.status === "paid") {
          clearInterval(pollHandle);
          window.location.href = "/checkout/success?orderId=" + data.orderId;
          return;
        }

        if (data.status === "failed") {
          clearInterval(pollHandle);
          const statusEl = document.getElementById("nets-status");
          statusEl.textContent = data.message || "Payment failed.";
          statusEl.classList.remove("d-none");
          netsBtn.disabled = false;
          netsBtn.querySelector(".spinner-border")?.classList.add("d-none");
          return;
        }

        if (attempts >= 20) {
          clearInterval(pollHandle);
          const statusEl = document.getElementById("nets-status");
          statusEl.textContent = "Payment timed out. Please try again.";
          statusEl.classList.remove("d-none");
          netsBtn.disabled = false;
          netsBtn.querySelector(".spinner-border")?.classList.add("d-none");
        }
      } catch (err) {
        console.error("NETS poll error:", err);
      }
    }, 3000);
  }

  // PayPal button
  if (window.paypal) {
    paypal.Buttons({
      style: { layout: 'vertical', shape: 'rect' },
      createOrder: async function () {
        if (!validateSchedule()) return;
        const selected = getSelectedItems();
        if (selected.length === 0) {
          alert("Please select at least one item.");
          return;
        }

        const res = await fetch('/api/paypal/create-order', {
          method: 'post',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({
            amount: parseFloat(totalDisplay.textContent.slice(1)),
            ...getCommonPayload()
          })
        });
        const data = await res.json();
        return data.id;
      },
      onApprove: async function (data) {
        const res = await fetch('/api/paypal/capture-order', {
          method: 'post',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ orderID: data.orderID })
        });
        const result = await res.json();
        if (result.success) {
          window.location.href = "/checkout/success?orderId=" + result.orderId;
        } else {
          alert(result.error || "Payment not completed.");
        }
      },
      onCancel: function () {
        alert("Payment cancelled.");
      },
      onError: function (err) {
        console.error(err);
        alert("PayPal error: " + err.message);
      }
    }).render('#paypal-button-container');
  }

  // Initial state
  updateSummary();
})();
</script>

<%- include("partials/footer"); %>
