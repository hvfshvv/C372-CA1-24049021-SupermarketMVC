<%- include("partials/header"); %>

    <div class="container mt-4 mb-5" style="max-width: 700px;">

        <h2 class="fw-bold mb-4 text-center">Checkout</h2>

        <div class="card p-4 shadow-sm">

            <h4 class="mb-3 fw-bold">Order Summary</h4>

            <% cart.forEach(item=> { %>
                <div class="d-flex justify-content-between border-bottom py-2">
                    <div>
                        <strong>
                            <%= item.productName %>
                        </strong><br>
                        Quantity: <%= item.quantity %>
                    </div>
                    <div>
                        $<%= (item.price * item.quantity).toFixed(2) %>
                    </div>
                </div>
                <% }); %>

                    <div class="d-flex justify-content-between mt-3">
                        <h4>Total:</h4>
                        <h4 class="fw-bold">$<%= total.toFixed(2) %>
                        </h4>
                    </div>

                    <hr class="my-4">

                    <!-- NETS QR PAYMENT -->
                    <h5 class="fw-bold mb-3">Pay with NETS QR </h5>
                    <div class="text-center mb-4">
                        <button id="nets-generate" class="btn btn-outline-primary mb-2">
                            Generate NETS QR
                        </button>
                        <div id="nets-status" class="text-muted small mb-2"></div>
                        <div id="nets-qr-container" class="d-flex justify-content-center"></div>
                    </div>

                    <hr class="my-4">

                    <!-- STRIPE PAYMENT -->
                    <h5 class="fw-bold mb-3">Pay with Card (Stripe)</h5>
                    <div class="text-center mb-4">
                        <button id="stripe-pay"
                            class="btn w-100 d-flex align-items-center justify-content-center gap-2 shadow-sm"
                            style="background:#635bff; border-color:#4b41d4; color:#fff; font-weight:600; height:50px; border-radius:8px;">
                            <span style="display:inline-flex; align-items:center; justify-content:center; width:30px; height:30px; border-radius:7px; background:#fff; color:#635bff; font-weight:800; font-size:16px; font-family:'Inter','Helvetica Neue',Arial,sans-serif;">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 18 18" width="18" height="18" fill="#635bff">
                                    <path d="M4 3h6.6c2.5 0 4.1 1.5 4.1 3.7 0 2.7-2.2 4-4.7 4H7.6l-.5 3.6H4L4 3Zm3.9 5.3h2.5c1 0 1.7-.6 1.7-1.5S11.6 5 10.6 5H7.9l.2 3.3Z"/>
                                </svg>
                            </span>
                            <span>Pay with Card (Stripe)</span>
                        </button>
                        <div id="stripe-status" class="text-muted small mt-2"></div>
                    </div>

                    <hr class="my-4">

                    <!-- PAYPAL PAYMENT -->
                    <h5 class="fw-bold mb-3">Pay with PayPal</h5>

                    <div id="paypal-button-container"></div>

                    <!-- PayPal SDK (Class style: uses env) -->
                    <script
                        src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=<%= currency %>"></script>
                    <script src="https://js.stripe.com/v3"></script>

                    <script>
                        (function () {
                            const netsBtn = document.getElementById("nets-generate");
                            const netsStatus = document.getElementById("nets-status");
                            const netsContainer = document.getElementById("nets-qr-container");
                            const stripeBtn = document.getElementById("stripe-pay");
                            const stripeStatus = document.getElementById("stripe-status");
                            let pollHandle = null;

                            function setStatus(message, isError = false) {
                                netsStatus.textContent = message;
                                netsStatus.classList.toggle("text-danger", !!isError);
                                netsStatus.classList.toggle("text-muted", !isError);
                            }

                            async function startPoll(txnRef) {
                                let attempts = 0;
                                pollHandle = setInterval(async () => {
                                    attempts++;
                                    try {
                                        const res = await fetch(`/api/nets/query?txn_retrieval_ref=${encodeURIComponent(txnRef)}`);
                                        const data = await res.json();

                                        if (data.status === "paid") {
                                            clearInterval(pollHandle);
                                            window.location.href = "/checkout/success?orderId=" + data.orderId;
                                            return;
                                        }

                                        if (data.status === "failed") {
                                            clearInterval(pollHandle);
                                            setStatus(data.message || "NETS payment failed.", true);
                                            netsBtn.disabled = false;
                                            return;
                                        }

                                        if (attempts >= 20) {
                                            clearInterval(pollHandle);
                                            setStatus("Payment timed out. Please try again.", true);
                                            netsBtn.disabled = false;
                                        }
                                    } catch (err) {
                                        console.error("NETS poll error:", err);
                                        clearInterval(pollHandle);
                                        setStatus("Error checking payment status.", true);
                                        netsBtn.disabled = false;
                                    }
                                }, 3000);
                            }

                            netsBtn?.addEventListener("click", async () => {
                                if (pollHandle) clearInterval(pollHandle);

                                netsBtn.disabled = true;
                                netsContainer.innerHTML = "";
                                setStatus("Requesting NETS QR...");

                                try {
                                    const res = await fetch("/api/nets/qr-request", {
                                        method: "POST",
                                        headers: {
                                            "accept": "application/json"
                                        }
                                    });

                                    const data = await res.json();

                                    if (!res.ok || !data.qrDataUrl) {
                                        const errorMsg = data?.error || "Unable to create NETS QR.";
                                        throw new Error(String(errorMsg));
                                    }

                                    const img = document.createElement("img");
                                    img.src = data.qrDataUrl;
                                    img.alt = "NETS QR Code";
                                    img.className = "img-fluid border p-2 bg-white";
                                    img.style.maxWidth = "360px";
                                    img.style.minWidth = "280px";
                                    netsContainer.appendChild(img);

                                    setStatus("Scan the QR with the NETS app to pay.");
                                    startPoll(data.txn_retrieval_ref);
                                } catch (err) {
                                    console.error("NETS request error:", err);
                                    setStatus(err.message, true);
                                    netsBtn.disabled = false;
                                }
                            });

                            // Stripe handler
                            stripeBtn?.addEventListener("click", async () => {
                                if (!"<%= stripePublishableKey %>" || !"<%= stripePublishableKey %>".startsWith("pk_")) {
                                    stripeStatus.textContent = "Stripe not configured (need publishable pk_ key).";
                                    stripeStatus.classList.add("text-danger");
                                    return;
                                }
                                stripeBtn.disabled = true;
                                stripeStatus.textContent = "Redirecting to Stripe...";
                                try {
                                    const res = await fetch("/api/stripe/create-session", {
                                        method: "POST",
                                        headers: { "accept": "application/json" }
                                    });
                                    const data = await res.json();
                                    if (!res.ok || !data.id) throw new Error(data.error || "Stripe error");

                                    const stripe = Stripe("<%= stripePublishableKey %>");
                                    const { error } = await stripe.redirectToCheckout({ sessionId: data.id });
                                    if (error) throw error;
                                } catch (err) {
                                    console.error("Stripe error:", err);
                                    stripeStatus.textContent = err.message || "Unable to start payment.";
                                    stripeStatus.classList.add("text-danger");
                                    stripeBtn.disabled = false;
                                }
                            });
                        })();
                    </script>

                    <script>
                    // Debug: Log the total value
                    console.log("PayPal total value:", <%= total %>, "Type:", typeof <%= total %>);
                    
                    paypal.Buttons({
                        style: {
                            layout: 'vertical',
                            shape: 'rect'
                        },

                    // call backend create-order with amount
                    createOrder: function () {
                        console.log("Creating PayPal order with amount:", <%= total.toFixed(2) %>);
                        return fetch('/api/paypal/create-order', {
                        method: 'post',
                        headers: {
                            'content-type': 'application/json',
                            'accept': 'application/json'
                        },
                        body: JSON.stringify({ amount: <%= total.toFixed(2) %> })
                        })
                        .then(res => res.json())
                        .then(data => data.id);
                        },

                        // call backend capture-order with PayPal orderID
                        onApprove: function (data) {
                        return fetch('/api/paypal/capture-order', {
                        method: 'post',
                        headers: {
                            'content-type': 'application/json',
                            'accept': 'application/json'
                        },
                        body: JSON.stringify({ orderID: data.orderID })
                        })
                        .then(res => res.json())
                        .then(result => {
                        
                        if (result.success) {
                        window.location.href = "/checkout/success?orderId=" + result.orderId;
                        } else {
                        alert(result.error || "Payment not completed.");
              }
            });
        },

    onCancel: function () {
      alert("Payment cancelled.");
    },

    onError: function (err) {
      console.error(err);
      alert("PayPal error: " + err.message);
    }

  }).render('#paypal-button-container');
</script>

        </div>
    </div>

    <%- include("partials/footer"); %>
