<%- include("partials/header"); %>

<!-- SWEETALERT2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<!-- SUCCESS POPUP (ADD / EDIT PRODUCT) -->
<% if (messages && messages.success && messages.success.length > 0) { %>
<script>
Swal.fire({
    icon: "success",
    title: "Success!",
    text: "<%= messages.success[0] %>",
    confirmButtonColor: "#28a745"
});
</script>
<% } %>

<div class="container mt-4">

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="fw-bold">Inventory Management</h2>
        <a href="/addproduct" class="btn btn-success rounded-4 fw-semibold">+ Add Product</a>
    </div>

    <div class="card shadow-sm p-3 rounded-4">

        <div class="table-responsive">
            <table class="table table-bordered table-striped align-middle">
                <thead class="table-dark">
                    <tr>
                        <th>ID</th>
                        <th>Image</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Qty</th>
                        <th>Price ($)</th>
                        <th>Actions</th>
                    </tr>
                </thead>

                <tbody>
                    <% products.forEach(p=> { %>
                        <tr class="<%= p.quantity < 10 ? 'table-danger' : '' %>">

                            <td><%= p.id %></td>

                            <td>
                                <img src="/images/<%= p.image %>"
                                    style="height:60px; width:60px; object-fit:cover; border-radius:8px;">
                            </td>

                            <td class="fw-semibold"><%= p.productName %></td>

                            <!-- CATEGORY BADGE -->
                            <td>
                                <span class="badge px-3 py-2 rounded-pill
                                    <% if (p.category === 'Fruits' || p.category === 'Vegetables') { %> bg-success 
                                    <% } else if (p.category === 'Dairy') { %> bg-primary 
                                    <% } else if (p.category === 'Bakery') { %> bg-warning text-dark
                                    <% } else if (p.category === 'Beverages') { %> bg-info text-dark
                                    <% } else if (p.category === 'Snacks') { %> bg-danger 
                                    <% } else { %> bg-secondary <% } %>">
                                    <%= p.category %>
                                </span>
                            </td>

                            <!-- QUANTITY -->
                            <td>
                                <% if (p.quantity < 10) { %>
                                    <span class="text-danger fw-bold">Low Stock (<%= p.quantity %>)</span>
                                <% } else { %>
                                    <%= p.quantity %>
                                <% } %>
                            </td>

                            <td>$<%= p.price.toFixed(2) %></td>

                            <td>
                                <a href="/updateproduct/<%= p.id %>" class="btn btn-warning btn-sm rounded-3">
                                    Edit
                                </a>

                                <!-- DELETE BUTTON WITH SWEETALERT -->
                                <button class="btn btn-danger btn-sm rounded-3"
                                    onclick="confirmDelete('<%= p.id %>')">
                                    Delete
                                </button>

                                <!-- Hidden form to submit on confirm -->
                                <form id="deleteForm-<%= p.id %>" 
                                    action="/deleteproduct/<%= p.id %>" 
                                    method="POST"
                                    style="display:none;">
                                </form>

                            </td>

                        </tr>
                    <% }) %>
                </tbody>

            </table>
        </div>

    </div>
</div>

<!-- SWEETALERT DELETE CONFIRMATION -->
<script>
function confirmDelete(id) {
    Swal.fire({
        title: "Delete this product?",
        text: "This action cannot be undone!",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#3085d6",
        confirmButtonText: "Yes, delete it",
        cancelButtonText: "Cancel",
        reverseButtons: true
    }).then((result) => {
        if (result.isConfirmed) {
            document.getElementById(`deleteForm-${id}`).submit();
        }
    });
}
</script>

<%- include("partials/footer"); %>
